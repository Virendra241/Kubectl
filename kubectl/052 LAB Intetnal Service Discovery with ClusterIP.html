<html>
                <head>
                <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
                <title>052 LAB Intetnal Service Discovery with ClusterIP</title>
                </head>
                <body>
                <div class="container">
                <div class="row">
                <div class="col-md-10 col-md-offset-1">
                    <p class="lead"><h4><strong>Internal Service Discovery</strong></h4><ul><li><p>Visit the <strong>vote</strong> app from browser</p></li><li><p>Attemp to vote by clicking on one of the options</p></li></ul><p>observe what happens. Does it go through?</p><p>Debugging,</p><pre class="prettyprint linenums">kubectl get pod
kubectl exec vote-xxxx ping redis

</pre><p>[replace xxxx with the actual pod id of one of the vote pods ]</p><p>keep the above command on a watch. You should create a new terminal to run the watch command.</p><p>e.g.</p><pre class="prettyprint linenums">watch  kubectl exec vote-kvc7j ping redis
</pre><p><strong>where, vote-kvc7j is one of the vote pods that I am running. Replace this with the actual pod id.</strong></p><p>Now create <strong>redis</strong> service</p><pre class="prettyprint linenums">kubectl apply -f redis-svc.yaml

kubectl get svc

kubectl describe svc redis
</pre><p>Watch the ping and observe if its able to resolve <strong>redis</strong> by hostname and its pointing to an IP address.</p><p>e.g.</p><pre class="prettyprint linenums">PING redis (10.102.77.6): 56 data bytes
</pre><p><strong>where 10.102.77.6 </strong>is the ClusterIP assigned to the service.</p><p>What happened here?</p><ul><li><p>Service <strong>redis</strong> was created with a ClusterIP e.g. 10.102.77.6</p></li><li><p>A DNS entry was created for this service. The fqdn of the service is <strong>redis.instavote.svc.cluster.local</strong> and it takes the form of my-svc.my-namespace.svc.cluster.local</p></li><li><p>Each pod points to internal DNS server running in the cluster. You could see the details of this by running the following commands</p></li></ul><pre class="prettyprint linenums">kubectl exec vote-xxxx cat /etc/resolv.conf
</pre><p><strong>[replace vote-xxxx with actual pod id]</strong></p><p>[sample output]</p><pre class="prettyprint linenums">nameserver 10.96.0.10
search instavote.svc.cluster.local svc.cluster.local cluster.local
options ndots:5
</pre><p>where <strong>10.96.0.10</strong> is the ClusterIP assigned to the DNS service. You could co relate that with,</p><pre class="prettyprint linenums">kubectl get svc -n kube-system


NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE
kube-dns               ClusterIP   10.96.0.10     &lt;none&gt;        53/UDP,53/TCP   h
kubernetes-dashboard   NodePort    10.104.42.73   &lt;none&gt;        80:31000/TCP    3m

</pre><p><strong>where, 10.96.0.10 </strong>is the ClusterIP assigned to <strong>kube-dns</strong> and matches the configuration in <strong>/etc/resolv.conf</strong> above.</p><h4><strong>Creating Endpoints for Redis</strong></h4><p>Service is been created, but you still need to launch the actual pods running <strong>redis</strong>application.</p><p>Create the endpoints now,</p><pre class="prettyprint linenums">kubectl apply -f redis-deploy.yaml
kubectl describe svc redis

</pre><p>[sample output]</p><pre class="prettyprint linenums">Name:              redis
Namespace:         instavote
Labels:            role=redis
                   tier=back
Annotations:       kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"role":"redis","tier":"back"},"name":"redis","namespace":"instavote"},"spec"...
Selector:          app=redis
Type:              ClusterIP
IP:                10.102.77.6
Port:              &lt;unset&gt;  6379/TCP
TargetPort:        6379/TCP
Endpoints:         10.32.0.6:6379,10.46.0.6:6379
Session Affinity:  None
Events:            &lt;none&gt;
</pre><p>Again, visit the vote app from browser, attempt to register your vote and observe what happens now.</p></p>
                </div>
                </div>
                </div>
                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
                </body>
                </html>